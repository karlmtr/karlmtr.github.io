<!-- Script qui permet de trouver les maximums d'une fonction -->
<!-- A OUVRIR DANS UN NAVIGATEUR -->
<!-- NECESSITE UNE CONNEXION INTERNET -->

<!DOCTYPE html><html><head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.10.2/p5.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <title>Trouver les maximums</title>
  </head>
  <body>

    <h1 align= "center">Script pour le labo : RESONNANCE MECANIQUE</h1>

    <center> Permet de trouver les maximums de l'amplitude à partir d'un fichier (TELECHARGER LE FICHIER ET OUVRIR DANS UN NAVIGATEUR (BESOIN DE CONNEXION INTERNET))</center> 
    <h2>Marche à suivre:</h2>
    <ol>
      <li>Sauvegarder les données sous <strong> 2 colonnes</strong> (temps, amplitude), séparées par <strong> une virgule</strong></li>
      <li>Importer le fichier de données</li>
      <li>Choisir de télécharger max1.txt, max2.txt, max3.txt</li>
      <li>Rafraîchir la page pour re-uploader un autre fichier</li>
    </ol>
    
    <h3>Choisir le fichier:</h3>

    <div id="tester" style="width:800px;height:600px;"></div>
    <script>
let input;
let x= [];
let y = [];
let maximums = [];
let tempVar;
let xMax = [];
let yMax = [];
let xMax2 = [];
let yMax2 = [];
let xMax3 = [];
let yMax3 = [];
let indices =[];
let button1;
let button2;
let button3;
let bool = false;

function setup() {
  input = createFileInput(calculerMax);
  input.position(10, 300)
    button1 = createButton('Télécharger: max1.txt');
    button1.position(10, 360);
    button1.mousePressed(save1);
  
    button2 = createButton('Télécharger: max2.txt');
    button2.position(170, 360);
    button2.mousePressed(save2);

    button3 = createButton('Télécharger: max3.txt');
    button3.position(330, 360);
    button3.mousePressed(save3);

    button1.hide();
    button2.hide();
    button3.hide();
}
function draw() {
  if(bool == true){
      button1.show();
      button2.show();
      button3.show();
  }
}
function calculerMax(file) {
    bool =true;
    data = file.data;
    data2= data.split("\n");
        
    for (let i = 0; i < data2.length; i++) {
        tempVar = data2[i].split(",");
        x.push(float(tempVar[0]));
        y.push(float(tempVar[1])); 
    }
    for (let i = 1; i < y.length-1; i++) {
        if ((y[i]>=y[i+1] && y[i-1]<y[i]) || (y[i]>y[i+1] && y[i-1]<=y[i])) {
            indices.push(i);
        }
    }

    for (let i = 0; i < indices.length; i++) {
        xMax.push(x[indices[i]]);
        yMax.push(y[indices[i]]);
    }
    indices = [];
    for (let i = 1; i < yMax.length-1; i++) {
        if ((yMax[i]>=yMax[i+1] && yMax[i-1]<y[i]) || (yMax[i]>yMax[i+1] && yMax[i-1]<=yMax[i])) {
            indices.push(i);
        }
    }
    for (let i = 0; i < indices.length; i++) {
        xMax2.push(xMax[indices[i]]);
        yMax2.push(yMax[indices[i]]);
    }

    indices = [];
    for (let i = 1; i < yMax2.length-1; i++) {
        if ((yMax2[i]>=yMax2[i+1] && yMax2[i-1]<y[i]) || (yMax2[i]>yMax2[i+1] && yMax2[i-1]<=yMax2[i])) {
            indices.push(i);
        }
    }
    for (let i = 0; i < indices.length; i++) {
        xMax3.push(xMax2[indices[i]]);
        yMax3.push(yMax2[indices[i]]);
    }

    let div = createDiv('div');
    var donnees = {
    x: x,
    y: y,
    mode:'markers',
    type:'scatter',
    name: 'Données',
    };

    var traceMax1 ={
        x:xMax,
        y:yMax,
        mode:'markers',
        type:'scatter',
        name: 'max1.txt'
    };

    var traceMax2 ={
        x:xMax2,
        y:yMax2,
        mode:'markers',
        type:'scatter',
        name: 'max2.txt'
    };

    var traceMax3 ={
        x:xMax3,
        y:yMax3,
        mode:'markers',
        type:'scatter',
        name: 'max3.txt'

    };
    var files =[donnees, traceMax1, traceMax2, traceMax3];
    Plotly.newPlot('tester', files);
}

function save1(){
    table = new p5.Table();
    table.addColumn('temps');
    table.addColumn('amplitude');
    let newRow;
    for (let i = 0; i < xMax.length; i++) {
        newRow = table.addRow();
        newRow.setString('temps', str(xMax[i]));
        newRow.setString('amplitude', str(yMax[i]));
    }
    
    saveTable(table,"max1.txt");
}

function save2(){

    table2 = new p5.Table();
    table2.addColumn('temps');
    table2.addColumn('amplitude');
    let newRow;
    for (let i = 0; i < xMax2.length; i++) {
        newRow = table.addRow();
        newRow.setString('temps', str(xMax2[i]));
        newRow.setString('amplitude', str(yMax3[i]));
    }
    saveTable(table2,"max2.txt");
}
function save3(){

    table3 = new p5.Table();
    table3.addColumn('temps');
    table3.addColumn('amplitude');
    let newRow;
    for (let i = 0; i < xMax3.length; i++) {
        newRow = table3.addRow();
        newRow.setString('temps', str(xMax3[i]));
        newRow.setString('amplitude', str(yMax3[i]));
    } 
    saveTable(table3,"max3.txt");
}
    </script>
</body>
</html>
